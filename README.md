# encrypt2bdy

使用python将文件加密后上传到百度云。

```
docker pull musnows/e2bdy
```

## 配置

1. 申请百度云盘开发者应用

先进行[个人开发者认证](https://pan.baidu.com/union/doc/ml0g2vtvb)（需要实名百度账户和绑定邮箱）然后[创建应用](https://pan.baidu.com/union/doc/fl0hhnulu)

记录下应用的 AppKey 和 Secretkey，分别填入环境变量的 `BDY_APP_KEY` 和 `BDY_SECRET_KEY`

可选环境变量：`BDY_APP_NAME` 应用名字，不填默认为 `e2bdy`

2. 映射路径

需要映射一个 `/app/config` 路径，作为数据库、配置文件、加密密钥的存放路径。

其他路径自由映射为你需要备份的路径。赋予读写权限以避免权限问题的BUG

3. 是否加密

设置环境变量 `ENCRYPT_UPLOAD` 为 1，文件将在加密后被上传。若不需要加密，请设置为0。

应用会在 `/app/config` 路径生成 `encrypt.key` 文件，该文件用于加密和解密文件的操作。

请注意，加密密钥不要发送、拷贝给任何人！同时也需要做好该密钥的备份操作，否则上传到百度云的加密文件将无法被正常解密！

> 后续将提供独立的解密程序，只要 `encrypt.key` 还存在，云端文件没有损坏，就能成功解密备份到百度云盘的文件。

4. 监控间隔

设置环境变量 `SYNC_INTERVAL` （单位：秒数），建议设置为大于600（即10分钟）的数值。~~如果您需要同步的文件非常之多，请适当延长此时间，避免出现上个task还没跑完，下一个就要开始了的情况。~~

> 目前程序使用的是单线程，并不会出现task冲突。所以您只需要根据你的需要，设置成合适的休眠时长。如果文件过多，但休眠时长过短，可能会导致硬盘io持续走高，影响其他进程运行。

程序将在对应间隔后重新检查本地路径的文件列表，并将新文件上传到百度云。

上传文件的判断基于本地数据库中，对应文件的哈希值是否存在。如果一个文件的哈希已经存在，则认为该文件已经上传。

所以，本程序并**不会**检查你是否已经将云端的文件删除，本地文件删除同样不会同步到云端。

> 后续将提供更多配置项来确定文件是否需要上传

5. 路径配置

将本仓库内 [config-exp.yml](./config/config-exp.yml) 复制并重命名为 `config.yml`，放入一个空文件夹，并将此文件夹映射给docker镜像的 `/app/config` 路径。

配置文件内只需要修改你的备份路径配置，其余token和配置项请以环境变量为准！下面给出备份路径配置示例。

假设我将我的硬盘映射到了docker容器的 `/hdd` 路径，并需要备份该路径中的 `照片` 文件夹。

照片文件夹内有如下文件

```
test/img1.png
img2.png
img3.png
```

在yaml内的配置如下

```yaml
- local: '/hdd/照片'
  remote: '照片1'
```

最终，程序会将文件上传到百度云盘的如下文件夹

```
apps/应用名称/照片1/hdd/照片/test/img1.png
apps/应用名称/照片1/hdd/照片/img2.png
apps/应用名称/照片1/hdd/照片/img3.png
```

* 其中 apps 文件夹在客户端中显示为 `我的应用数据`，百度网盘使用api上传的文件只能上传到此路径。
* 应用名称为第一点中提到的 `BDY_APP_NAME` 环境变量。
* 如果你开启了加密，程序会给文件添加上加密的后缀 `.e2bdy`

请注意，远端文件路径只能指定为文件夹名称，或只能中间带上路径分隔符！

```bash
/test/test   # 不合法
./test/test  # 不合法
test/test/   # 不合法
./test/test/ # 不合法
test/test    # ok
```

请遵循如上配置要求，否则程序会在检测到远端路径配置无效后直接退出。

## 支持

您的下载使用就是对本人最大的任何可支持！如果能给个star就更好啦！

有任何问题，欢迎提出issue
